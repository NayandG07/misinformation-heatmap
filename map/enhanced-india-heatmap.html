<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misinformation Heatmap - India</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #2d1810;
            --accent: #FF9933;
            --high-risk: #dc3545;
            --medium-risk: #ffc107;
            --low-risk: #138808;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            /* Indian Tricolor inspired dark theme */
            background: linear-gradient(135deg, 
                #1a1a1a 0%,    /* Dark base */
                #2d1810 25%,   /* Dark saffron tone */
                #1a1a1a 50%,   /* Dark base */
                #0d1a0d 75%,   /* Dark green tone */
                #1a1a1a 100%   /* Dark base */
            );
            color: #e6eef8;
            display: flex;
            min-height: 100vh;
        }
        
        #left {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            padding: 16px 20px;
            background: linear-gradient(90deg, rgba(255, 153, 51, 0.1), transparent);
            display: flex;
            gap: 16px;
            align-items: center;
            border-bottom: 2px solid rgba(255, 153, 51, 0.3);
        }
        
        header h1 {
            font-size: 24px;
            margin: 0;
            background: linear-gradient(135deg, #FF9933 0%, #138808 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-bar {
            padding: 12px 20px;
            background: rgba(255,255,255,0.02);
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #mapwrap {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #svgroot {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            cursor: grab;
            background: linear-gradient(180deg, #071027, #082035);
            transition: transform 0.2s ease;
        }
        
        #svgroot:active {
            cursor: grabbing;
        }
        
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .zoom-btn:active {
            transform: scale(0.95);
        }
        
        .zoom-level {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        #live-feed {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        #live-feed .activity-title {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
        }
        
        #live-feed::-webkit-scrollbar {
            width: 4px;
        }
        
        #live-feed::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #live-feed::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        
        #live-feed::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes newItem {
            0% { background: rgba(103, 126, 234, 0.3); }
            100% { background: rgba(255,255,255,0.03); }
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #e6eef8;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 153, 51, 0.3);
            border-top: 4px solid #FF9933;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #FF9933;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF9933, #138808);
            width: 0%;
            transition: width 0.3s ease;
            animation: progress 3s ease-in-out infinite;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        #tooltip {
            position: absolute;
            pointer-events: none;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #041026;
            border-radius: 8px;
            font-size: 13px;
            box-shadow: 0 8px 24px rgba(4,8,16,0.6);
            display: none;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }
        
        aside {
            width: 320px;
            background: var(--panel);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 20px 16px;
            box-sizing: border-box;
            overflow-y: auto;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
        }
        
        .state-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .state-stats {
            background: rgba(255,255,255,0.05);
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .risk-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .risk-high { background: var(--high-risk); color: white; }
        .risk-medium { background: var(--medium-risk); color: #212529; }
        .risk-low { background: var(--low-risk); color: white; }
        
        .trending-topics {
            margin: 16px 0;
        }
        
        .topic-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        
        .recent-headlines {
            margin: 16px 0;
        }
        
        .headline {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid var(--accent);
            font-size: 13px;
            line-height: 1.4;
        }
        
        .legend {
            margin-top: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .legend h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        /* Map styling */
        .map-path {
            fill: #88A4BC;
            stroke: #ffffff;
            stroke-width: 0.6;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .map-path:hover {
            stroke-width: 1.2;
            filter: brightness(1.2);
        }
        
        .selected {
            stroke: #ffffff;
            stroke-width: 2;
            filter: brightness(1.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }
        
        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="left">
        <header>
            <h1>üáÆüá≥ Misinformation Heatmap</h1>
            <div style="display: flex; gap: 2rem; margin-left: 2rem;">
                <a href="/" style="color: #a0a0a0; text-decoration: none; font-weight: 500; transition: color 0.3s ease;">Home</a>
                <a href="/dashboard" style="color: #a0a0a0; text-decoration: none; font-weight: 500; transition: color 0.3s ease;">Dashboard</a>
                <a href="/map/enhanced-india-heatmap.html" style="color: #FF9933; text-decoration: none; font-weight: 500;">Heatmap</a>
            </div>
            <div style="flex: 1;"></div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="testMapColors()" style="background: rgba(255, 153, 51, 0.2); border: 1px solid rgba(255, 153, 51, 0.4); color: #FF9933; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">üé® Test Colors</button>
                <button onclick="showDataSummary()" style="background: rgba(19, 136, 8, 0.2); border: 1px solid rgba(19, 136, 8, 0.4); color: #138808; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">üìä Data Summary</button>
                <div class="status-indicator" style="display: flex; align-items: center; gap: 0.5rem; background: rgba(19, 136, 8, 0.1); border: 1px solid rgba(19, 136, 8, 0.3); border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.9rem; color: #138808;">
                    <div style="width: 8px; height: 8px; background: #138808; border-radius: 50%; animation: pulse 2s infinite;"></div>
                    <span>Live Processing</span>
                </div>
            </div>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Live Processing</span>
            </div>
            <div class="status-item">
                <strong id="total-events">Loading...</strong> Total Events
            </div>
            <div class="status-item">
                <strong id="active-states">Loading...</strong> Active States
            </div>
            <div class="status-item">
                Last Update: <strong id="last-update">Loading...</strong>
            </div>
            <div class="status-item">
                Accuracy: <strong id="classification-accuracy">Loading...</strong>
            </div>
        </div>
        
        <div id="mapwrap">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <div class="zoom-level" id="zoom-level">100%</div>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                <button class="zoom-btn" onclick="resetZoom()" title="Reset View">‚åÇ</button>
            </div>
            <div id="svgroot">
                <div class="loading" id="loading-screen">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">üó∫Ô∏è Loading Enhanced India Map...</div>
                    <div class="loading-subtext">Fetching real-time misinformation data</div>
                    <div class="loading-progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
            </div>
            <div id="tooltip"></div>
        </div>
    </div>
    
    <aside>
        <div class="state-name" id="stateName">Select a State</div>
        <div id="stateContent">
            <div style="margin-top: 20px;">
                <h4 style="font-size: 14px; margin-bottom: 10px; color: #667eea;">Risk Levels</h4>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 2px;"></div>
                        <span>High Risk (‚â•60%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 2px;"></div>
                        <span>Medium Risk (40-59%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: #28a745; border-radius: 2px;"></div>
                        <span>Low Risk (<40%)</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; opacity: 0.7; margin-top: 20px; font-size: 12px;">
                Click on a state to view detailed fake news analysis
            </div>
            
            <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 25px;">
                <h3 style="font-size: 17px; margin-bottom: 18px; color: #dc3545; display: flex; align-items: center; gap: 10px; font-weight: 700;">
                    <span style="width: 10px; height: 10px; background: #dc3545; border-radius: 50%; animation: pulse 2s infinite;"></span>
                    üö® Misinformation Alerts
                </h3>
                <div id="misinformation-feed" style="max-height: 400px; overflow-y: auto; font-size: 14px; border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 8px; background: rgba(220, 53, 69, 0.05); margin-bottom: 25px; padding: 12px;">
                    <div style="opacity: 0.7; text-align: center; padding: 50px;">
                        <div style="font-size: 24px; margin-bottom: 12px;">üö®</div>
                        <div style="font-size: 15px; font-weight: 600;">Loading misinformation alerts...</div>
                        <div style="font-size: 13px; margin-top: 8px; opacity: 0.8;">Scanning for fake news</div>
                    </div>
                </div>
                
                <h3 style="font-size: 17px; margin-bottom: 18px; color: #138808; display: flex; align-items: center; gap: 10px; font-weight: 700;">
                    <span style="width: 10px; height: 10px; background: #138808; border-radius: 50%; animation: pulse 2s infinite;"></span>
                    ‚úÖ Verified Real News
                </h3>
                <div id="real-news-feed" style="max-height: 450px; overflow-y: auto; font-size: 14px; border: 1px solid rgba(19, 136, 8, 0.3); border-radius: 8px; background: rgba(19, 136, 8, 0.05); padding: 12px;">
                    <div style="opacity: 0.7; text-align: center; padding: 50px;">
                        <div style="font-size: 24px; margin-bottom: 12px;">üì∞</div>
                        <div style="font-size: 15px; font-weight: 600;">Loading verified news...</div>
                        <div style="font-size: 13px; margin-top: 8px; opacity: 0.8;">Fetching latest real news updates</div>
                    </div>
                </div>
            </div>
        </div>
        

    </aside>

    <script>
        // Global variables
        let heatmapData = [];
        let selectedState = null;
        let svgMap = null;
        
        // Caching variables for performance
        let dataCache = new Map();
        let lastDataFetch = 0;
        const CACHE_DURATION = 30000; // 30 seconds cache
        
        // Zoom and pan variables
        let currentZoom = 1;
        let currentX = 0;
        let currentY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        const minZoom = 0.5;
        const maxZoom = 5;
        const zoomStep = 0.2;
        
        // Initialize the enhanced heatmap
        async function initializeEnhancedHeatmap() {
            try {
                // Load the SVG map
                await loadSVGMap();
                
                // Load heatmap data
                await loadHeatmapData();
                
                // Update status bar and live feeds
                await updateStatusBar();
                await updateLiveFeeds();
                
                // Optimized refresh intervals for better performance
                setInterval(async () => {
                    await loadHeatmapData();
                }, 60000); // Update map every 60 seconds (less frequent)
                
                setInterval(async () => {
                    await updateStatusBar();
                }, 30000); // Update status every 30 seconds
                
                setInterval(updateLiveFeeds, 15000); // Update live feeds every 15 seconds (less frequent)
                
            } catch (error) {
                console.error('Failed to initialize heatmap:', error);
                document.getElementById('svgroot').innerHTML = 
                    '<div class="error">Failed to load heatmap data. Please refresh the page.</div>';
            }
        }
        
        async function loadSVGMap() {
            try {
                const response = await fetch('./in.svg');
                const svgText = await response.text();
                
                const svgRoot = document.getElementById('svgroot');
                svgRoot.innerHTML = svgText;
                
                svgMap = svgRoot.querySelector('svg');
                if (svgMap) {
                    svgMap.style.width = '100%';
                    svgMap.style.height = '100%';
                    
                    // Add click handlers to all paths
                    const paths = svgMap.querySelectorAll('path');
                    console.log(`SVG loaded successfully with ${paths.length} paths`);
                    
                    paths.forEach(path => {
                        path.classList.add('map-path');
                        path.addEventListener('click', handleStateClick);
                        path.addEventListener('mouseenter', handleStateHover);
                        path.addEventListener('mouseleave', handleStateLeave);
                    });
                    
                    // Setup zoom and pan functionality
                    setupZoomAndPan();
                } else {
                    console.error('SVG element not found in loaded content');
                }
            } catch (error) {
                console.error('Failed to load SVG map:', error);
                throw error;
            }
        }
        
        async function loadHeatmapData() {
            try {
                const now = Date.now();
                
                // Check cache first
                if (dataCache.has('heatmap') && (now - lastDataFetch) < CACHE_DURATION) {
                    heatmapData = dataCache.get('heatmap');
                    applyHeatmapColors();
                    return;
                }
                
                // Show loading progress
                updateLoadingProgress(30);
                
                const response = await fetch('/api/v1/heatmap/data');
                const data = await response.json();
                
                updateLoadingProgress(70);
                
                heatmapData = data.heatmap_data || [];
                
                // Cache the data
                dataCache.set('heatmap', heatmapData);
                lastDataFetch = now;
                
                updateLoadingProgress(90);
                
                // Apply colors to map
                applyHeatmapColors();
                
                updateLoadingProgress(100);
                
                // Hide loading screen after first load
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Failed to load heatmap data:', error);
            }
        }
        
        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }
        
        function applyHeatmapColors() {
            if (!svgMap || !heatmapData.length) {
                console.log('Cannot apply colors:', { svgMap: !!svgMap, dataLength: heatmapData.length });
                return;
            }
            
            const paths = svgMap.querySelectorAll('path');
            console.log(`Applying colors to ${paths.length} paths with ${heatmapData.length} data points`);
            
            let matchedCount = 0;
            let unmatchedPaths = [];
            
            paths.forEach((path, index) => {
                const stateData = findStateData(path);
                
                if (stateData) {
                    const color = getColorForRisk(stateData.fake_probability, stateData.risk_level);
                    path.style.fill = color;
                    path.style.stroke = '#ffffff';
                    path.style.strokeWidth = '0.5';
                    path.setAttribute('data-state', stateData.state);
                    path.setAttribute('data-events', stateData.event_count);
                    path.setAttribute('data-risk', stateData.risk_level);
                    
                    // Debug logging for first few matches
                    if (index < 5) {
                        console.log(`State: ${stateData.state}, Fake Ratio: ${(stateData.fake_probability * 100).toFixed(2)}%, Risk: ${stateData.risk_level}, Color: ${color}`);
                    }
                    
                    matchedCount++;
                } else {
                    path.style.fill = '#88A4BC'; // Default color for unmatched states
                    path.style.stroke = '#ffffff';
                    path.style.strokeWidth = '0.5';
                    const pathName = path.getAttribute('name') || path.id || 'unknown';
                    unmatchedPaths.push(pathName);
                }
            });
            
            console.log(`Matched ${matchedCount} states, unmatched: ${unmatchedPaths.length}`);
            if (unmatchedPaths.length > 0) {
                console.log('Unmatched paths:', unmatchedPaths);
            }
        }
        
        // State name mapping for better matching
        const stateNameMapping = {
            'andaman and nicobar': 'Andaman and Nicobar Islands',
            'andhra pradesh': 'Andhra Pradesh',
            'arunachal pradesh': 'Arunachal Pradesh',
            'assam': 'Assam',
            'bihar': 'Bihar',
            'chandigarh': 'Chandigarh',
            'chhattisgarh': 'Chhattisgarh',
            'dƒÅdra and nagar haveli and damƒÅn and diu': 'Dadra and Nagar Haveli and Daman and Diu',
            'delhi': 'Delhi',
            'goa': 'Goa',
            'gujarat': 'Gujarat',
            'haryana': 'Haryana',
            'himachal pradesh': 'Himachal Pradesh',
            'jharkhand': 'Jharkhand',
            'karnataka': 'Karnataka',
            'kerala': 'Kerala',
            'lakshadweep': 'Lakshadweep',
            'madhya pradesh': 'Madhya Pradesh',
            'maharashtra': 'Maharashtra',
            'manipur': 'Manipur',
            'meghalaya': 'Meghalaya',
            'mizoram': 'Mizoram',
            'nagaland': 'Nagaland',
            'orissa': 'Odisha',
            'punjab': 'Punjab',
            'puducherry': 'Puducherry',
            'rajasthan': 'Rajasthan',
            'sikkim': 'Sikkim',
            'tamil nadu': 'Tamil Nadu',
            'telangana': 'Telangana',
            'tripura': 'Tripura',
            'uttar pradesh': 'Uttar Pradesh',
            'uttaranchal': 'Uttarakhand',
            'west bengal': 'West Bengal',
            'jammu and kashmir': 'Jammu and Kashmir',
            'ladakh': 'Ladakh'
        };

        function findStateData(pathElement) {
            // Try to match state by various attributes
            const pathId = pathElement.id;
            const pathTitle = pathElement.getAttribute('title');
            const pathName = pathElement.getAttribute('name');
            
            // Get the SVG state name (usually from name attribute)
            let svgStateName = pathName || pathTitle || pathId;
            if (!svgStateName) return null;
            
            svgStateName = svgStateName.toLowerCase();
            
            // Try direct mapping first
            const mappedName = stateNameMapping[svgStateName];
            if (mappedName) {
                const found = heatmapData.find(state => state.state === mappedName);
                if (found) return found;
            }
            
            // Fallback to fuzzy matching
            return heatmapData.find(state => {
                const stateName = state.state.toLowerCase();
                return (
                    svgStateName.includes(stateName) ||
                    stateName.includes(svgStateName) ||
                    svgStateName.replace(/\s+/g, '') === stateName.replace(/\s+/g, '') ||
                    // Handle common variations
                    (svgStateName === 'orissa' && stateName === 'odisha') ||
                    (svgStateName === 'uttaranchal' && stateName === 'uttarakhand')
                );
            });
        }
        
        function getColorForRisk(fakeRatio, riskLevel) {
            // Use actual fake news ratios for meaningful colors
            if (riskLevel === 'insufficient_data') {
                return '#88A4BC'; // Gray for insufficient data
            }
            
            if (fakeRatio > 0.1) return '#dc3545'; // High risk - red (>10% fake)
            if (fakeRatio > 0.05) return '#ff6b35'; // Medium risk - orange (5-10% fake)
            if (fakeRatio > 0.02) return '#ffc107'; // Low-medium risk - yellow (2-5% fake)
            if (fakeRatio > 0.001) return '#FF9933'; // Low risk - saffron (0.1-2% fake)
            return '#138808'; // Very low risk - green (<0.1% fake)
        }
        
        function handleStateClick(event) {
            const path = event.target;
            const stateData = findStateData(path);
            
            if (stateData) {
                // Remove previous selection
                svgMap.querySelectorAll('.selected').forEach(p => p.classList.remove('selected'));
                
                // Select current state
                path.classList.add('selected');
                selectedState = stateData.state;
                
                // Show state details
                showStateDetails(stateData);
                
                // Load state-specific events
                loadStateEvents(stateData.state);
            }
        }
        
        function handleStateHover(event) {
            const path = event.target;
            const stateData = findStateData(path);
            
            if (stateData) {
                showTooltip(event, stateData);
            }
        }
        
        function handleStateLeave(event) {
            hideTooltip();
        }
        
        function showTooltip(event, stateData) {
            let tooltip = document.getElementById('tooltip');
            
            // Create tooltip if it doesn't exist
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 10px;
                    border-radius: 6px;
                    font-size: 12px;
                    z-index: 1000;
                    pointer-events: none;
                    max-width: 200px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                `;
                document.body.appendChild(tooltip);
            }
            
            const fakePercentage = (stateData.fake_probability * 100).toFixed(2);
            const aiConfidence = stateData.ai_confidence ? (stateData.ai_confidence * 100).toFixed(1) : 'N/A';
            
            tooltip.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">${stateData.state}</div>
                <div>Total Events: ${stateData.event_count || 0}</div>
                <div>Fake News: ${stateData.fake_count || 0} (${fakePercentage}%)</div>
                <div>Real News: ${stateData.real_count || 0}</div>
                <div>AI Confidence: ${aiConfidence}%</div>
                <div>Risk Level: <span style="color: ${stateData.risk_level === 'high' ? '#dc3545' : stateData.risk_level === 'medium' ? '#ffc107' : '#138808'};">${stateData.risk_level || 'low'}</span></div>
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        function showStateDetails(stateData) {
            document.getElementById('stateName').textContent = stateData.state;
            
            // Get state info from INDIAN_STATES if available
            const stateInfo = Object.values(window.INDIAN_STATES || {}).find(s => s.name === stateData.state) || {};
            
            document.getElementById('stateContent').innerHTML = `
                <div class="state-stats">
                    <div class="stat-row">
                        <span>Total Events:</span>
                        <span class="stat-value">${stateData.event_count || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span>Fake News:</span>
                        <span class="stat-value" style="color: var(--high-risk);">${stateData.fake_count || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span>Real News:</span>
                        <span class="stat-value" style="color: var(--low-risk);">${stateData.real_count || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span>Fake News Ratio:</span>
                        <span class="stat-value" style="color: var(--high-risk);">${(stateData.fake_probability * 100).toFixed(2)}%</span>
                    </div>
                    <div class="stat-row">
                        <span>AI Confidence:</span>
                        <span class="stat-value" style="color: var(--medium-risk);">${stateData.ai_confidence ? (stateData.ai_confidence * 100).toFixed(1) : 'N/A'}%</span>
                    </div>
                    <div class="stat-row">
                        <span>Risk Level:</span>
                        <span class="stat-value" style="color: ${stateData.risk_level === 'high' ? 'var(--high-risk)' : stateData.risk_level === 'medium' ? 'var(--medium-risk)' : 'var(--low-risk)'};">${stateData.risk_level || 'low'}</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px; color: #667eea;">Fake News Ratio Legend</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 2px;"></div>
                            <span>High Risk (>10% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #ff6b35; border-radius: 2px;"></div>
                            <span>Medium Risk (5-10% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 2px;"></div>
                            <span>Low-Medium Risk (2-5% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #FF9933; border-radius: 2px;"></div>
                            <span>Low Risk (0.1-2% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #138808; border-radius: 2px;"></div>
                            <span>Very Low Risk (<0.1% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #88A4BC; border-radius: 2px;"></div>
                            <span>Insufficient Data (<50 events)</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; opacity: 0.7; margin-top: 20px; font-size: 12px;">
                    Click on a state to view detailed analysis
                </div>
            `;
        }
        
        async function loadStateEvents(state) {
            try {
                const response = await fetch(`/api/v1/events/state/${encodeURIComponent(state)}`);
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    const eventsHtml = data.events.map(event => `
                        <div class="headline" style="margin-bottom: 12px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                            <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; line-height: 1.3;">${event.title || 'Processing event...'}</div>
                            <div style="font-size: 11px; opacity: 0.8; color: #a0a0a0;">
                                ${event.source || 'Unknown source'} ‚Ä¢ 
                                <span style="color: ${event.classification === 'fake' ? '#dc3545' : event.classification === 'real' ? '#138808' : '#ffc107'};">
                                    ${(event.classification || 'uncertain').toUpperCase()}
                                </span> 
                                (${((event.fake_probability || 0.5) * 100).toFixed(0)}%)
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('stateContent').innerHTML += `
                        <div style="margin-top: 20px;">
                            <h4>üîç Recent Analysis</h4>
                            ${eventsHtml}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load state events:', error);
            }
        }
        
        async function updateStatusBar() {
            try {
                const response = await fetch('/api/v1/stats');
                const data = await response.json();
                
                document.getElementById('total-events').textContent = data.total_events || 0;
                document.getElementById('active-states').textContent = data.total_states || 36;
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.querySelector('.status-bar .status-item span');
                
                if (data.processing_active) {
                    statusDot.style.background = '#138808';
                    statusText.textContent = 'Live Processing';
                    statusDot.style.animation = 'pulse 2s infinite';
                } else {
                    statusDot.style.background = '#FF9933';
                    statusText.textContent = 'System Ready';
                    statusDot.style.animation = 'pulse 2s infinite';
                }
                
                // Update classification accuracy
                const accuracy = data.recent_hour_stats?.classification_accuracy || data.classification_accuracy || 0;
                const accuracyPercent = Math.round(accuracy * 100);
                document.getElementById('classification-accuracy').textContent = `${accuracyPercent}%`;
                
                // Color code accuracy
                const accuracyElement = document.getElementById('classification-accuracy');
                if (accuracyPercent >= 80) {
                    accuracyElement.style.color = '#28a745';
                } else if (accuracyPercent >= 60) {
                    accuracyElement.style.color = '#ffc107';
                } else {
                    accuracyElement.style.color = '#dc3545';
                }
                
            } catch (error) {
                console.error('Failed to update status bar:', error);
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.querySelector('.status-bar .status-item span');
                if (statusDot && statusText) {
                    statusDot.style.background = '#dc3545';
                    statusText.textContent = 'Connection Error';
                    statusDot.style.animation = 'none';
                }
            }
        }
        
        // Zoom and Pan Functions
        function updateTransform() {
            if (svgMap) {
                svgMap.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;
                document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
            }
        }
        
        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom = Math.min(maxZoom, currentZoom + zoomStep);
                updateTransform();
            }
        }
        
        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom = Math.max(minZoom, currentZoom - zoomStep);
                updateTransform();
            }
        }
        
        function resetZoom() {
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateTransform();
        }
        
        function setupZoomAndPan() {
            const svgRoot = document.getElementById('svgroot');
            
            // Mouse wheel zoom
            svgRoot.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = svgRoot.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const oldZoom = currentZoom;
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
                
                // Zoom towards mouse position
                if (currentZoom !== oldZoom) {
                    const zoomRatio = currentZoom / oldZoom;
                    currentX = mouseX - (mouseX - currentX) * zoomRatio;
                    currentY = mouseY - (mouseY - currentY) * zoomRatio;
                    updateTransform();
                }
            });
            
            // Mouse drag pan
            svgRoot.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left mouse button
                    isDragging = true;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    svgRoot.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    
                    currentX += deltaX;
                    currentY += deltaY;
                    
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    
                    updateTransform();
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    svgRoot.style.cursor = 'grab';
                }
            });
            
            // Touch support for mobile
            let lastTouchDistance = 0;
            let lastTouchX = 0;
            let lastTouchY = 0;
            
            svgRoot.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    // Single touch - pan
                    lastTouchX = e.touches[0].clientX;
                    lastTouchY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // Two touches - zoom
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    lastTouchDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                }
                e.preventDefault();
            });
            
            svgRoot.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    // Single touch - pan
                    const deltaX = e.touches[0].clientX - lastTouchX;
                    const deltaY = e.touches[0].clientY - lastTouchY;
                    
                    currentX += deltaX;
                    currentY += deltaY;
                    
                    lastTouchX = e.touches[0].clientX;
                    lastTouchY = e.touches[0].clientY;
                    
                    updateTransform();
                } else if (e.touches.length === 2) {
                    // Two touches - zoom
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    
                    if (lastTouchDistance > 0) {
                        const zoomRatio = currentDistance / lastTouchDistance;
                        const newZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom * zoomRatio));
                        
                        if (newZoom !== currentZoom) {
                            currentZoom = newZoom;
                            updateTransform();
                        }
                    }
                    
                    lastTouchDistance = currentDistance;
                }
                e.preventDefault();
            });
        }

        // Utility functions for map interaction
        
        // Test function to force colors on map
        function testMapColors() {
            if (!svgMap) {
                console.log('SVG map not loaded yet');
                return;
            }
            
            const paths = svgMap.querySelectorAll('path');
            console.log(`Testing colors on ${paths.length} paths`);
            
            paths.forEach((path, index) => {
                // Apply different colors to test
                const colors = ['#dc3545', '#ff6b35', '#FF9933', '#ffc107', '#138808'];
                const color = colors[index % colors.length];
                path.style.fill = color;
                path.style.stroke = '#ffffff';
                path.style.strokeWidth = '1';
            });
            
            console.log('Test colors applied');
        }
        
        // Function to show data summary
        function showDataSummary() {
            console.log('=== HEATMAP DATA SUMMARY ===');
            console.log(`Total states in data: ${heatmapData.length}`);
            
            if (heatmapData.length > 0) {
                const probabilities = heatmapData.map(d => d.fake_probability);
                const min = Math.min(...probabilities);
                const max = Math.max(...probabilities);
                const avg = probabilities.reduce((a, b) => a + b, 0) / probabilities.length;
                
                console.log(`Fake probability range: ${min.toFixed(3)} - ${max.toFixed(3)}`);
                console.log(`Average fake probability: ${avg.toFixed(3)}`);
                
                // Show first 5 states
                console.log('First 5 states:');
                heatmapData.slice(0, 5).forEach(state => {
                    console.log(`  ${state.state}: ${state.fake_probability.toFixed(3)} (${state.event_count} events)`);
                });
            }
        }
        

        
        // Enhanced live feed with separate misinformation and real news feeds
        let lastEventId = null;
        let feedUpdateCount = 0;
        
        async function updateLiveFeeds() {
            await updateMisinformationFeed();
            await updateRealNewsFeed();
        }
        
        async function updateMisinformationFeed() {
            try {
                const response = await fetch('/api/v1/events/live?limit=20');
                const data = await response.json();
                
                const misinformationFeed = document.getElementById('misinformation-feed');
                if (data.events && data.events.length > 0) {
                    // Filter for fake/uncertain news
                    const fakeEvents = data.events.filter(event => 
                        event.verdict === 'fake' || event.verdict === 'uncertain'
                    );
                    
                    if (fakeEvents.length > 0) {
                        const feedHtml = fakeEvents.slice(0, 10).map((event, index) => {
                            const verdictColor = event.verdict === 'fake' ? '#dc3545' : '#ffc107';
                            const confidencePercent = Math.round(event.confidence * 100);
                            
                            return `
                                <div style="border-left: 4px solid ${verdictColor}; padding: 16px 18px; margin-bottom: 12px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; transition: all 0.3s ease;" 
                                     onmouseover="this.style.background='rgba(220, 53, 69, 0.2)'; this.style.transform='translateX(2px)'" 
                                     onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'; this.style.transform='translateX(0)'">
                                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; line-height: 1.5; color: #dc3545;">
                                        üö® ${event.title.substring(0, 90)}${event.title.length > 90 ? '...' : ''}
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px; color: #a0a0a0; line-height: 1.3;">
                                        ${event.source} ‚Ä¢ ${event.state || 'Unknown location'}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                                        <span style="color: ${verdictColor}; font-weight: bold; padding: 4px 10px; background: rgba(220, 53, 69, 0.2); border-radius: 14px;">
                                            ${event.verdict.toUpperCase()}
                                        </span>
                                        <span style="color: #dc3545; font-weight: 600;">
                                            ${confidencePercent}% confidence
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        misinformationFeed.innerHTML = feedHtml;
                    } else {
                        misinformationFeed.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: #138808;">
                                <div style="font-size: 32px; margin-bottom: 15px;">‚úÖ</div>
                                <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">No misinformation detected recently!</div>
                                <div style="font-size: 14px; opacity: 0.8; line-height: 1.4;">All news sources are showing verified content</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Failed to update misinformation feed:', error);
            }
        }
        
        async function updateRealNewsFeed() {
            try {
                const response = await fetch('/api/v1/events/live?limit=20');
                const data = await response.json();
                
                const realNewsFeed = document.getElementById('real-news-feed');
                if (data.events && data.events.length > 0) {
                    // Filter for real news
                    const realEvents = data.events.filter(event => event.verdict === 'real');
                    
                    if (realEvents.length > 0) {
                        const feedHtml = realEvents.slice(0, 10).map((event, index) => {
                            const confidencePercent = Math.round(event.confidence * 100);
                            
                            return `
                                <div style="border-left: 4px solid #138808; padding: 16px 18px; margin-bottom: 12px; background: rgba(19, 136, 8, 0.1); border-radius: 8px; transition: all 0.3s ease;" 
                                     onmouseover="this.style.background='rgba(19, 136, 8, 0.2)'; this.style.transform='translateX(2px)'" 
                                     onmouseout="this.style.background='rgba(19, 136, 8, 0.1)'; this.style.transform='translateX(0)'">
                                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; line-height: 1.5; color: #138808;">
                                        ‚úÖ ${event.title.substring(0, 90)}${event.title.length > 90 ? '...' : ''}
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px; color: #a0a0a0; line-height: 1.3;">
                                        ${event.source} ‚Ä¢ ${event.state || 'Unknown location'}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                                        <span style="color: #138808; font-weight: bold; padding: 4px 10px; background: rgba(19, 136, 8, 0.2); border-radius: 14px;">
                                            VERIFIED
                                        </span>
                                        <span style="color: #138808; font-weight: 600;">
                                            ${confidencePercent}% confidence
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        realNewsFeed.innerHTML = feedHtml;
                    } else {
                        realNewsFeed.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; opacity: 0.7;">
                                <div style="font-size: 28px; margin-bottom: 15px;">üì∞</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Loading verified news...</div>
                                <div style="font-size: 14px; margin-top: 8px; line-height: 1.4;">Fetching latest real news updates</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Failed to update real news feed:', error);
            }
        }
        
        // Legacy function for compatibility
        async function updateLiveFeed() {
            try {
                const response = await fetch('/api/v1/events/live?limit=15');
                const data = await response.json();
                
                const liveFeed = document.getElementById('live-feed');
                if (data.events && data.events.length > 0) {
                    feedUpdateCount++;
                    
                    const feedHtml = data.events.map((event, index) => {
                        const verdictColor = event.verdict === 'fake' ? '#dc3545' : 
                                           event.verdict === 'real' ? '#28a745' : '#ffc107';
                        const confidencePercent = Math.round(event.confidence * 100);
                        
                        // Calculate realistic time ago based on timestamp
                        const now = new Date();
                        const eventTime = new Date(event.timestamp);
                        const diffMinutes = Math.floor((now - eventTime) / (1000 * 60));
                        const timeAgo = diffMinutes < 1 ? 'Just now' : 
                                       diffMinutes < 60 ? `${diffMinutes}m ago` : 
                                       diffMinutes < 1440 ? `${Math.floor(diffMinutes/60)}h ago` : 
                                       `${Math.floor(diffMinutes/1440)}d ago`;
                        
                        // Add animation for new items
                        const isNew = index < 3 && feedUpdateCount > 1;
                        const animationStyle = isNew ? 'animation: slideIn 0.5s ease-out;' : '';
                        
                        return `
                            <div style="border-left: 3px solid ${verdictColor}; padding: 10px 12px; margin-bottom: 1px; background: ${index % 2 === 0 ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.01)'}; transition: all 0.3s ease; ${animationStyle}" 
                                 onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateX(2px)'" 
                                 onmouseout="this.style.background='${index % 2 === 0 ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.01)'}'; this.style.transform='translateX(0)'">
                                <div style="font-weight: bold; margin-bottom: 6px; font-size: 11px; line-height: 1.3;">
                                    ${event.title.substring(0, 75)}${event.title.length > 75 ? '...' : ''}
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 10px; opacity: 0.8; margin-bottom: 4px;">
                                    <span style="color: #667eea; font-weight: 500;">${event.source}</span>
                                    <span style="color: ${verdictColor}; font-weight: bold; font-size: 9px; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                                        ${event.verdict.toUpperCase()}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 9px; opacity: 0.6;">
                                    <span>${timeAgo}</span>
                                    <span style="color: ${confidencePercent >= 70 ? '#28a745' : confidencePercent >= 50 ? '#ffc107' : '#dc3545'};">
                                        ${confidencePercent}% confidence
                                    </span>
                                </div>
                                ${event.state ? `<div style="font-size: 8px; opacity: 0.5; margin-top: 2px;">üìç ${event.state}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    liveFeed.innerHTML = feedHtml;
                    
                    // Update feed header with count
                    const feedHeader = document.querySelector('h3');
                    if (feedHeader && feedHeader.textContent.includes('Live Classification Feed')) {
                        feedHeader.innerHTML = `
                            <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; animation: pulse 2s infinite;"></span>
                            Live Classification Feed (${data.events.length})
                        `;
                    }
                    
                } else {
                    liveFeed.innerHTML = `
                        <div style="opacity: 0.7; text-align: center; padding: 30px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üì°</div>
                            <div>Processing news feeds...</div>
                            <div style="font-size: 10px; margin-top: 5px; opacity: 0.6;">Waiting for new events</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Failed to update live feed:', error);
                document.getElementById('live-feed').innerHTML = `
                    <div style="opacity: 0.7; text-align: center; padding: 30px; color: #dc3545;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Feed temporarily unavailable</div>
                        <div style="font-size: 10px; margin-top: 5px; opacity: 0.6;">Retrying connection...</div>
                    </div>
                `;
            }
        }
        
        // State-specific news feed functions
        async function updateStateSpecificFeeds(state) {
            try {
                const response = await fetch(`/api/v1/events/state/${encodeURIComponent(state)}?limit=20`);
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    // Filter for fake/uncertain news
                    const fakeEvents = data.events.filter(event => 
                        event.verdict === 'fake' || event.verdict === 'uncertain'
                    );
                    
                    // Filter for real news
                    const realEvents = data.events.filter(event => event.verdict === 'real');
                    
                    // Update misinformation feed
                    const misinformationFeed = document.getElementById('misinformation-feed');
                    if (fakeEvents.length > 0) {
                        const fakeHtml = fakeEvents.slice(0, 8).map((event, index) => {
                            const verdictColor = event.verdict === 'fake' ? '#dc3545' : '#ffc107';
                            const confidencePercent = Math.round(event.confidence * 100);
                            
                            return `
                                <div style="border-left: 4px solid ${verdictColor}; padding: 16px 18px; margin-bottom: 12px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; transition: all 0.3s ease;" 
                                     onmouseover="this.style.background='rgba(220, 53, 69, 0.2)'; this.style.transform='translateX(2px)'" 
                                     onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'; this.style.transform='translateX(0)'">
                                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; line-height: 1.5; color: #dc3545;">
                                        üö® ${event.title.substring(0, 90)}${event.title.length > 90 ? '...' : ''}
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px; color: #a0a0a0; line-height: 1.3;">
                                        ${event.source} ‚Ä¢ ${state}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                                        <span style="color: ${verdictColor}; font-weight: bold; padding: 4px 10px; background: rgba(220, 53, 69, 0.2); border-radius: 14px;">
                                            ${event.verdict.toUpperCase()}
                                        </span>
                                        <span style="color: #dc3545; font-weight: 600;">
                                            ${confidencePercent}% confidence
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        misinformationFeed.innerHTML = fakeHtml;
                    } else {
                        misinformationFeed.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: #138808;">
                                <div style="font-size: 32px; margin-bottom: 15px;">‚úÖ</div>
                                <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">No misinformation in ${state}!</div>
                                <div style="font-size: 14px; opacity: 0.8; line-height: 1.4;">All news from this state is verified</div>
                            </div>
                        `;
                    }
                    
                    // Update real news feed
                    const realNewsFeed = document.getElementById('real-news-feed');
                    if (realEvents.length > 0) {
                        const realHtml = realEvents.slice(0, 10).map((event, index) => {
                            const confidencePercent = Math.round(event.confidence * 100);
                            
                            return `
                                <div style="border-left: 4px solid #138808; padding: 16px 18px; margin-bottom: 12px; background: rgba(19, 136, 8, 0.1); border-radius: 8px; transition: all 0.3s ease;" 
                                     onmouseover="this.style.background='rgba(19, 136, 8, 0.2)'; this.style.transform='translateX(2px)'" 
                                     onmouseout="this.style.background='rgba(19, 136, 8, 0.1)'; this.style.transform='translateX(0)'">
                                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px; line-height: 1.5; color: #138808;">
                                        ‚úÖ ${event.title.substring(0, 90)}${event.title.length > 90 ? '...' : ''}
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px; color: #a0a0a0; line-height: 1.3;">
                                        ${event.source} ‚Ä¢ ${state}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                                        <span style="color: #138808; font-weight: bold; padding: 4px 10px; background: rgba(19, 136, 8, 0.2); border-radius: 14px;">
                                            VERIFIED
                                        </span>
                                        <span style="color: #138808; font-weight: 600;">
                                            ${confidencePercent}% confidence
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        realNewsFeed.innerHTML = realHtml;
                    } else {
                        realNewsFeed.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; opacity: 0.7;">
                                <div style="font-size: 28px; margin-bottom: 15px;">üì∞</div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No recent news from ${state}</div>
                                <div style="font-size: 14px; margin-top: 8px; line-height: 1.4;">Check back later for updates</div>
                            </div>
                        `;
                    }
                } else {
                    // No events for this state
                    document.getElementById('misinformation-feed').innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; opacity: 0.7;">
                            <div style="font-size: 28px; margin-bottom: 15px;">üìä</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No recent data for ${state}</div>
                            <div style="font-size: 14px; margin-top: 8px; line-height: 1.4;">Processing new events...</div>
                        </div>
                    `;
                    
                    document.getElementById('real-news-feed').innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; opacity: 0.7;">
                            <div style="font-size: 28px; margin-bottom: 15px;">üìä</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No recent data for ${state}</div>
                            <div style="font-size: 14px; margin-top: 8px; line-height: 1.4;">Processing new events...</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load state-specific feeds:', error);
            }
        }
        
        // State interaction functions
        function handleStateClick(event) {
            const path = event.target;
            const stateData = findStateData(path);
            
            if (stateData) {
                // Check if this state is already selected
                if (selectedState === stateData.state) {
                    // Unselect the state
                    unselectState();
                    return;
                }
                
                // Remove previous selection
                const previousSelected = svgMap.querySelector('.selected');
                if (previousSelected) {
                    previousSelected.classList.remove('selected');
                    previousSelected.style.strokeWidth = '0.5';
                }
                
                // Select current state
                path.classList.add('selected');
                path.style.strokeWidth = '2';
                selectedState = stateData.state;
                
                // Show state details
                showStateDetails(stateData);
                
                // Load state-specific events and update feeds
                loadStateEvents(stateData.state);
                updateStateSpecificFeeds(stateData.state);
            }
        }
        function handleStateClick(event) {
            const path = event.target;
            const stateData = findStateData(path);
            
            if (stateData) {
                // Check if this state is already selected
                if (selectedState === stateData.state) {
                    // Unselect the state
                    unselectState();
                    return;
                }
                
                // Remove previous selection
                const previousSelected = svgMap.querySelector('.selected');
                if (previousSelected) {
                    previousSelected.classList.remove('selected');
                    previousSelected.style.strokeWidth = '0.5';
                }
                
                // Select current state
                path.classList.add('selected');
                path.style.strokeWidth = '2';
                selectedState = stateData.state;
                
                // Show state details
                showStateDetails(stateData);
                
                // Load state-specific events
                loadStateEvents(stateData.state);
            }
        }
        
        function unselectState() {
            // Remove selection from map
            const selectedPath = svgMap.querySelector('.selected');
            if (selectedPath) {
                selectedPath.classList.remove('selected');
                selectedPath.style.strokeWidth = '0.5';
            }
            
            // Reset state
            selectedState = null;
            
            // Reset sidebar to default view
            document.getElementById('stateName').textContent = 'Select a State';
            document.getElementById('stateContent').innerHTML = `
                <div style="margin-top: 20px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px; color: #667eea;">Risk Levels</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 2px;"></div>
                            <span>High Risk (‚â•60%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 2px;"></div>
                            <span>Medium Risk (40-59%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #28a745; border-radius: 2px;"></div>
                            <span>Low Risk (<40%)</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; opacity: 0.7; margin-top: 20px; font-size: 12px;">
                    Click on a state to view detailed fake news analysis
                </div>
                
                <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 25px;">
                    <h3 style="font-size: 17px; margin-bottom: 18px; color: #dc3545; display: flex; align-items: center; gap: 10px; font-weight: 700;">
                        <span style="width: 10px; height: 10px; background: #dc3545; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        üö® Misinformation Alerts
                    </h3>
                    <div id="misinformation-feed" style="max-height: 400px; overflow-y: auto; font-size: 14px; border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 8px; background: rgba(220, 53, 69, 0.05); margin-bottom: 25px; padding: 12px;">
                        <div style="opacity: 0.7; text-align: center; padding: 50px;">
                            <div style="font-size: 24px; margin-bottom: 12px;">üö®</div>
                            <div style="font-size: 15px; font-weight: 600;">Loading misinformation alerts...</div>
                            <div style="font-size: 13px; margin-top: 8px; opacity: 0.8;">Scanning for fake news</div>
                        </div>
                    </div>
                    
                    <h3 style="font-size: 17px; margin-bottom: 18px; color: #138808; display: flex; align-items: center; gap: 10px; font-weight: 700;">
                        <span style="width: 10px; height: 10px; background: #138808; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        ‚úÖ Verified Real News
                    </h3>
                    <div id="real-news-feed" style="max-height: 450px; overflow-y: auto; font-size: 14px; border: 1px solid rgba(19, 136, 8, 0.3); border-radius: 8px; background: rgba(19, 136, 8, 0.05); padding: 12px;">
                        <div style="opacity: 0.7; text-align: center; padding: 50px;">
                            <div style="font-size: 24px; margin-bottom: 12px;">üì∞</div>
                            <div style="font-size: 15px; font-weight: 600;">Loading verified news...</div>
                            <div style="font-size: 13px; margin-top: 8px; opacity: 0.8;">Fetching latest real news updates</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Restore global feeds
            updateLiveFeeds();
        }
        
        function handleStateHover(event) {
            const path = event.target;
            const stateData = findStateData(path);
            
            if (stateData) {
                showTooltip(event, stateData);
            }
        }
        
        function handleStateLeave(event) {
            hideTooltip();
        }
        
        function showTooltip(event, stateData) {
            let tooltip = document.getElementById('tooltip');
            
            // Create tooltip if it doesn't exist
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 10px;
                    border-radius: 6px;
                    font-size: 12px;
                    z-index: 1000;
                    pointer-events: none;
                    max-width: 200px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                `;
                document.body.appendChild(tooltip);
            }
            
            const fakePercentage = (stateData.fake_probability * 100).toFixed(2);
            const aiConfidence = stateData.ai_confidence ? (stateData.ai_confidence * 100).toFixed(1) : 'N/A';
            
            tooltip.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">${stateData.state}</div>
                <div>Total Events: ${stateData.event_count || 0}</div>
                <div>Fake News: ${stateData.fake_count || 0} (${fakePercentage}%)</div>
                <div>Real News: ${stateData.real_count || 0}</div>
                <div>AI Confidence: ${aiConfidence}%</div>
                <div>Risk Level: <span style="color: ${stateData.risk_level === 'high' ? '#dc3545' : stateData.risk_level === 'medium' ? '#ffc107' : '#138808'};">${stateData.risk_level || 'low'}</span></div>
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
        }
        
        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        function showStateDetails(stateData) {
            document.getElementById('stateName').textContent = stateData.state;
            
            document.getElementById('stateContent').innerHTML = `
                <div class="state-stats">
                    <div class="stat-row">
                        <span>Total Events:</span>
                        <span class="stat-value">${stateData.event_count || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span>Fake News:</span>
                        <span class="stat-value" style="color: var(--high-risk);">${stateData.fake_count || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span>Real News:</span>
                        <span class="stat-value" style="color: var(--low-risk);">${stateData.real_count || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span>Fake News Ratio:</span>
                        <span class="stat-value" style="color: var(--high-risk);">${(stateData.fake_probability * 100).toFixed(2)}%</span>
                    </div>
                    <div class="stat-row">
                        <span>AI Confidence:</span>
                        <span class="stat-value" style="color: var(--medium-risk);">${stateData.ai_confidence ? (stateData.ai_confidence * 100).toFixed(1) : 'N/A'}%</span>
                    </div>
                    <div class="stat-row">
                        <span>Risk Level:</span>
                        <span class="stat-value" style="color: ${stateData.risk_level === 'high' ? 'var(--high-risk)' : stateData.risk_level === 'medium' ? 'var(--medium-risk)' : 'var(--low-risk)'};">${stateData.risk_level || 'low'}</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="unselectState()" style="background: rgba(255, 153, 51, 0.2); border: 1px solid #FF9933; color: #FF9933; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 153, 51, 0.3)'" onmouseout="this.style.background='rgba(255, 153, 51, 0.2)'">
                        ‚úï Unselect State
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px; color: #667eea;">Fake News Ratio Legend</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #dc3545; border-radius: 2px;"></div>
                            <span>High Risk (>10% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #ff6b35; border-radius: 2px;"></div>
                            <span>Medium Risk (5-10% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #ffc107; border-radius: 2px;"></div>
                            <span>Low-Medium Risk (2-5% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #FF9933; border-radius: 2px;"></div>
                            <span>Low Risk (0.1-2% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #138808; border-radius: 2px;"></div>
                            <span>Very Low Risk (<0.1% fake)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 16px; height: 16px; background: #88A4BC; border-radius: 2px;"></div>
                            <span>Insufficient Data (<50 events)</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; opacity: 0.7; margin-top: 20px; font-size: 12px;">
                    Click on another state or use the unselect button above
                </div>
            `;
        }
        
        // Test Colors Debug Function
        function testMapColors() {
            if (!svgMap) {
                console.log('SVG map not loaded yet');
                return;
            }
            
            const paths = svgMap.querySelectorAll('path');
            console.log(`Testing colors on ${paths.length} paths`);
            
            paths.forEach((path, index) => {
                // Apply different colors to test
                const colors = ['#dc3545', '#ff6b35', '#FF9933', '#ffc107', '#138808'];
                const color = colors[index % colors.length];
                path.style.fill = color;
                path.style.stroke = '#ffffff';
                path.style.strokeWidth = '1';
            });
            
            console.log('Test colors applied - click states to see interaction');
        }
        
        // Add test colors button to zoom controls
        function addTestColorsButton() {
            const zoomControls = document.querySelector('.zoom-controls');
            if (zoomControls) {
                const testButton = document.createElement('button');
                testButton.className = 'zoom-btn';
                testButton.onclick = testMapColors;
                testButton.title = 'Test Colors';
                testButton.textContent = 'üé®';
                zoomControls.appendChild(testButton);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeEnhancedHeatmap();
            // Add test colors button after a short delay
            setTimeout(addTestColorsButton, 1000);
        });
    </script>
</body>
</html>